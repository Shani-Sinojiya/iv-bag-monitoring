<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>IV Bag Monitoring - Live Dashboard</title>
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        margin: 0;
        padding: 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      .container {
        background: white;
        border-radius: 15px;
        padding: 40px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        text-align: center;
        max-width: 600px;
        width: 100%;
      }

      h1 {
        color: #333;
        margin-bottom: 30px;
        font-size: 2.5em;
      }

      .weight-display {
        font-size: 4em;
        font-weight: bold;
        color: #4caf50;
        margin: 30px 0;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        transition: color 0.3s ease;
      }

      .weight-display.alert {
        color: #f44336;
        animation: pulse 1s infinite;
      }

      @keyframes pulse {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.05);
        }
        100% {
          transform: scale(1);
        }
      }

      .status {
        display: flex;
        justify-content: space-between;
        margin: 20px 0;
        padding: 20px;
        background: #f5f5f5;
        border-radius: 10px;
      }

      .status-item {
        text-align: center;
      }

      .status-label {
        font-size: 0.9em;
        color: #666;
        margin-bottom: 5px;
      }

      .status-value {
        font-size: 1.2em;
        font-weight: bold;
        color: #333;
      }

      .connection-status {
        padding: 10px 20px;
        border-radius: 20px;
        font-weight: bold;
        margin: 20px 0;
        transition: all 0.3s ease;
      }

      .connected {
        background-color: #4caf50;
        color: white;
      }

      .disconnected {
        background-color: #f44336;
        color: white;
      }

      .alert-message {
        background-color: #ffebee;
        border: 2px solid #f44336;
        color: #c62828;
        padding: 15px;
        border-radius: 10px;
        margin: 20px 0;
        font-weight: bold;
        display: none;
      }

      .alert-message.show {
        display: block;
        animation: slideIn 0.5s ease;
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(-20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .threshold-info {
        background: #e3f2fd;
        border-left: 4px solid #2196f3;
        padding: 15px;
        margin: 20px 0;
        border-radius: 5px;
      }

      .last-update {
        color: #666;
        font-size: 0.9em;
        margin-top: 20px;
      }

      .chart-container {
        margin-top: 30px;
        height: 200px;
        background: #f9f9f9;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #666;
      }

      .test-audio-btn {
        position: fixed;
        bottom: 10px;
        right: 10px;
        z-index: 1000;
        padding: 12px 16px;
        background: #f44336;
        color: white;
        border: none;
        border-radius: 25px;
        cursor: pointer;
        font-size: 14px;
        font-weight: bold;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        transition: all 0.3s ease;
      }

      .test-audio-btn:hover {
        background: #d32f2f;
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
      }

      .test-audio-btn:active {
        transform: translateY(0);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üè• IV Bag Monitor</h1>

      <div id="connectionStatus" class="connection-status disconnected">
        Connecting...
      </div>

      <div class="weight-display" id="weightDisplay">-- g</div>

      <div class="status">
        <div class="status-item">
          <div class="status-label">Threshold</div>
          <div class="status-value">{{ threshold }}g</div>
        </div>
        <div class="status-item">
          <div class="status-label">Status</div>
          <div class="status-value" id="statusText">Monitoring</div>
        </div>
        <div class="status-item">
          <div class="status-label">Last Update</div>
          <div class="status-value" id="lastUpdate">Never</div>
        </div>
      </div>

      <div id="alertMessage" class="alert-message">
        ‚ö†Ô∏è CRITICAL: Weight below threshold! Please refill IV bag immediately!
      </div>

      <div class="threshold-info">
        <strong>Alert Threshold:</strong> {{ threshold }}g<br />
        An audio alert will sound when the weight drops below this value.
      </div>

      <div class="last-update" id="timestamp">Waiting for data...</div>
    </div>

    <!-- Audio element for alert -->
    <audio id="alertSound" preload="auto" loop>
      <source src="/static/alert.mp3" type="audio/mpeg" />
      <source src="/static/alert.wav" type="audio/wav" />
      <source src="/static/alert.ogg" type="audio/ogg" />
      Your browser does not support the audio element.
    </audio>

    <!-- Test audio button for verification -->
    <button onclick="testAudio()" class="test-audio-btn">
      üîä Test Alert Sound
    </button>

    <script>
      class IVMonitor {
          constructor() {
              this.ws = null;
              this.threshold = {{ threshold }};
              this.lastWeight = null;
              this.isAlertActive = false;
              this.reconnectAttempts = 0;
              this.maxReconnectAttempts = 5;
              this.notificationId = 0; // Unique notification counter
              this.activeNotifications = new Map(); // Track active notifications

              this.elements = {
                  weightDisplay: document.getElementById('weightDisplay'),
                  connectionStatus: document.getElementById('connectionStatus'),
                  statusText: document.getElementById('statusText'),
                  lastUpdate: document.getElementById('lastUpdate'),
                  alertMessage: document.getElementById('alertMessage'),
                  timestamp: document.getElementById('timestamp'),
                  alertSound: document.getElementById('alertSound')
              };

              this.connect();
          }

          connect() {
              const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
              const wsUrl = `${protocol}//${window.location.host}/ws`;

              this.ws = new WebSocket(wsUrl);

              this.ws.onopen = () => {
                  console.log('WebSocket connected');
                  this.updateConnectionStatus(true);
                  this.reconnectAttempts = 0;
              };

              this.ws.onmessage = (event) => {
                  try {
                      const data = JSON.parse(event.data);
                      this.updateDisplay(data);
                  } catch (error) {
                      console.error('Error parsing WebSocket message:', error);
                  }
              };

              this.ws.onclose = () => {
                  console.log('WebSocket disconnected');
                  this.updateConnectionStatus(false);
                  this.attemptReconnect();
              };

              this.ws.onerror = (error) => {
                  console.error('WebSocket error:', error);
                  this.updateConnectionStatus(false);
              };
          }

          attemptReconnect() {
              if (this.reconnectAttempts < this.maxReconnectAttempts) {
                  this.reconnectAttempts++;
                  const delay = Math.min(1000 * Math.pow(2, this.reconnectAttempts), 30000);

                  setTimeout(() => {
                      console.log(`Attempting to reconnect... (${this.reconnectAttempts}/${this.maxReconnectAttempts})`);
                      this.connect();
                  }, delay);
              } else {
                  console.error('Max reconnection attempts reached');
                  this.elements.connectionStatus.textContent = 'Connection Failed';
              }
          }

          updateConnectionStatus(connected) {
              const status = this.elements.connectionStatus;
              if (connected) {
                  status.textContent = 'Connected';
                  status.className = 'connection-status connected';
              } else {
                  status.textContent = 'Disconnected';
                  status.className = 'connection-status disconnected';
              }
          }

          updateDisplay(data) {
              const { weight, timestamp, alert } = data;

              // Update weight display
              this.elements.weightDisplay.textContent = `${weight}g`;

              // Update timestamp
              const date = new Date(timestamp);
              this.elements.lastUpdate.textContent = date.toLocaleTimeString();
              this.elements.timestamp.textContent = `Last updated: ${date.toLocaleString()}`;

              // Handle alert status
              if (alert && !this.isAlertActive) {
                  this.triggerAlert();
                  this.elements.weightDisplay.classList.add('alert');
                  this.elements.statusText.textContent = 'ALERT!';

                  // Update alert message with notification ID
                  this.elements.alertMessage.innerHTML = `
                      ‚ö†Ô∏è CRITICAL: Weight below threshold! Please refill IV bag immediately!<br>
                      <small>Alert ID: alert-${Date.now()}-${this.notificationId}</small>
                  `;
                  this.elements.alertMessage.classList.add('show');
                  this.isAlertActive = true;
              } else if (!alert && this.isAlertActive) {
                  this.clearAlert();
                  this.elements.weightDisplay.classList.remove('alert');
                  this.elements.statusText.textContent = 'Normal';
                  this.elements.alertMessage.classList.remove('show');
                  this.isAlertActive = false;
              } else if (!alert) {
                  this.elements.statusText.textContent = 'Normal';
              }

              this.lastWeight = weight;
          }

          triggerAlert() {
              // Generate unique notification ID
              this.notificationId++;
              const alertId = `alert-${Date.now()}-${this.notificationId}`;

              console.log(`üö® THRESHOLD ALERT TRIGGERED! ID: ${alertId}`);
              console.log(`Weight: ${this.lastWeight}g, Threshold: ${this.threshold}g`);

              // Enhanced audio alert with multiple attempts
              this.playAlertSound();

              // Show browser notification if permitted
              if (Notification.permission === 'granted') {
                  const notification = new Notification('üö® IV Bag CRITICAL Alert', {
                      body: `Alert ID: ${alertId}\nWeight: ${this.lastWeight}g - BELOW THRESHOLD of ${this.threshold}g!\nREFILL IMMEDIATELY!`,
                      icon: '/static/favicon.ico',
                      tag: alertId,
                      requireInteraction: true,
                      vibrate: [200, 100, 200] // Vibration pattern for mobile
                  });

                  // Store the notification with its ID
                  this.activeNotifications.set(alertId, {
                      notification: notification,
                      timestamp: new Date(),
                      weight: this.lastWeight
                  });

                  // Auto-close notification after 15 seconds
                  setTimeout(() => {
                      notification.close();
                      this.activeNotifications.delete(alertId);
                  }, 15000);
              }

              // Log the alert for tracking
              this.logAlert(alertId);
          }

          playAlertSound() {
              const audio = this.elements.alertSound;

              // Reset audio to beginning
              audio.currentTime = 0;

              // Set volume to maximum
              audio.volume = 1.0;

              // Play the alert sound with multiple fallback attempts
              const playAudio = () => {
                  const playPromise = audio.play();

                  if (playPromise !== undefined) {
                      playPromise
                          .then(() => {
                              console.log('üîä Alert audio playing successfully!');

                              // Stop the audio after 3 seconds and replay if still in alert state
                              setTimeout(() => {
                                  if (this.isAlertActive) {
                                      audio.pause();
                                      audio.currentTime = 0;
                                      // Play again after a brief pause
                                      setTimeout(() => {
                                          if (this.isAlertActive) {
                                              this.playAlertSound();
                                          }
                                      }, 500);
                                  }
                              }, 3000);
                          })
                          .catch(error => {
                              console.warn('Audio play failed:', error);
                              this.fallbackAlert();

                              // Try alternative audio methods
                              this.tryAlternativeAudio();
                          });
                  }
              };

              // Try to play immediately
              playAudio();

              // Fallback: try again after a short delay
              setTimeout(() => {
                  if (this.isAlertActive && audio.paused) {
                      console.log('üîÑ Retrying audio play...');
                      playAudio();
                  }
              }, 100);
          }

          tryAlternativeAudio() {
              // Try Web Audio API beep as fallback
              try {
                  const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                  const oscillator = audioContext.createOscillator();
                  const gainNode = audioContext.createGain();

                  oscillator.connect(gainNode);
                  gainNode.connect(audioContext.destination);

                  oscillator.frequency.value = 800; // High frequency beep
                  oscillator.type = 'sine';

                  gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                  gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);

                  oscillator.start(audioContext.currentTime);
                  oscillator.stop(audioContext.currentTime + 0.5);

                  console.log('üéµ Web Audio API beep played as fallback');

                  // Repeat beep 3 times
                  setTimeout(() => this.tryAlternativeAudio(), 600);

              } catch (error) {
                  console.warn('Web Audio API fallback failed:', error);
                  // Ultimate fallback - visual alert
                  this.fallbackAlert();
              }
          }

          clearAlert() {
              // Stop the audio if it's playing
              this.elements.alertSound.pause();
              this.elements.alertSound.currentTime = 0;

              // Clear any active notifications
              this.activeNotifications.forEach((alertData, alertId) => {
                  alertData.notification.close();
              });
              this.activeNotifications.clear();
          }

          fallbackAlert(alertId = 'fallback-' + Date.now()) {
              // Fallback alert using system beep or visual indication
              console.warn(`üö® FALLBACK ALERT [ID: ${alertId}]: Weight below threshold!`);

              // Visual fallback - flash the page
              document.body.style.backgroundColor = '#ffcdd2';
              setTimeout(() => {
                  document.body.style.backgroundColor = '';
              }, 500);

              // Log the fallback alert
              this.logAlert(alertId, 'fallback');
          }

          logAlert(alertId, type = 'standard') {
              // Log alert details for tracking and debugging
              const alertLog = {
                  id: alertId,
                  type: type,
                  timestamp: new Date().toISOString(),
                  weight: this.lastWeight,
                  threshold: this.threshold,
                  severity: this.lastWeight < (this.threshold * 0.5) ? 'critical' : 'warning'
              };

              console.log('üìã Alert Log:', alertLog);

              // Store in localStorage for persistence (optional)
              try {
                  const existingLogs = JSON.parse(localStorage.getItem('iv-alerts') || '[]');
                  existingLogs.push(alertLog);

                  // Keep only last 50 alerts
                  if (existingLogs.length > 50) {
                      existingLogs.splice(0, existingLogs.length - 50);
                  }

                  localStorage.setItem('iv-alerts', JSON.stringify(existingLogs));
              } catch (error) {
                  console.warn('Could not save alert to localStorage:', error);
              }
          }

          getAlertHistory() {
              // Method to retrieve alert history
              try {
                  return JSON.parse(localStorage.getItem('iv-alerts') || '[]');
              } catch (error) {
                  console.warn('Could not retrieve alert history:', error);
                  return [];
              }
          }
      }

      // Test audio function
      function testAudio() {
          console.log('üîß Testing alert audio...');
          const audio = document.getElementById('alertSound');
          audio.currentTime = 0;
          audio.volume = 1.0;

          const playPromise = audio.play();
          if (playPromise !== undefined) {
              playPromise
                  .then(() => {
                      console.log('‚úÖ Test audio played successfully!');
                      // Stop after 2 seconds
                      setTimeout(() => {
                          audio.pause();
                          audio.currentTime = 0;
                      }, 2000);
                  })
                  .catch(error => {
                      console.error('‚ùå Test audio failed:', error);
                      alert('Audio test failed. Please check browser audio permissions.');
                  });
          }
      }

      // Request notification permission on page load
      if ('Notification' in window && Notification.permission === 'default') {
          Notification.requestPermission().then(permission => {
              console.log('üîî Notification permission:', permission);
          });
      }

      // Initialize the monitor when page loads
      document.addEventListener('DOMContentLoaded', () => {
          window.monitor = new IVMonitor();

          // Preload and test audio
          const audio = document.getElementById('alertSound');
          audio.load(); // Preload the audio

          console.log('üè• IV Monitor initialized');
          console.log('üîä Audio element loaded and ready');
          console.log('Available commands:');
          console.log('- window.monitor.getAlertHistory() - Get alert history');
          console.log('- window.monitor.activeNotifications - View active notifications');
          console.log('- window.monitor.notificationId - Current notification counter');
          console.log('- testAudio() - Test the alert sound');

          // User interaction to enable audio (required by browsers)
          document.addEventListener('click', function enableAudio() {
              const audio = document.getElementById('alertSound');
              audio.play().then(() => {
                  audio.pause();
                  audio.currentTime = 0;
                  console.log('üéµ Audio enabled by user interaction');
              }).catch(() => {
                  console.log('‚ö†Ô∏è Audio still requires user permission');
              });

              // Remove this listener after first click
              document.removeEventListener('click', enableAudio);
          });
      });

      // Keep connection alive
      setInterval(() => {
          if (window.monitor && window.monitor.ws && window.monitor.ws.readyState === WebSocket.OPEN) {
              window.monitor.ws.send('ping');
          }
      }, 30000);
    </script>
  </body>
</html>
